---
title: "HW3"
author: "Caitlin Bolz"
date: "2/18/2021"
output: html_document
---

What time of day should you fly if you want to avoid delays as much as possible? 
Does this choice depend on anything? Season? Weather? Airport? Airline? 

Three patterns
* precipitation ???
* destination
* visibility

Report
* Introduction -- summarizes the three results
* Section for each finding
* Support each finding with data summaries and visualizations
* Include code only when necessary


Talk about how I'm looking specifically at departure delay instead of arrival delay. Arrival delay is based more on what happens in the air and can't be controlled as well. Departure delay is based on what  happens on the ground and is more controllable. Maybe talk about hour vs sched_dep_time vs dep_time

```{r include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(nycflights13)
library(grid)
```

Graph looking strictly at flight times and delay
```{r}
flights %>%
  group_by(hour) %>%
  filter(!is.na(dep_delay)) %>%
  summarise( delay = mean( dep_delay > 0 , na.rm = T)) %>%
  ggplot() + geom_col(aes(hour, delay, fill = delay)) + scale_fill_continuous(type = "viridis")
```



# Destination

Average delay for each destination
```{r fig.width=6, fig.height=13}
flights %>%
  group_by(dest) %>%
  filter(!is.na(dep_delay)) %>%
  filter(!is.na(dest)) %>% 
  summarise(tot_mins = sum(dep_delay[dep_delay > 0]),
            n = n(),
            avg = tot_mins/n) %>%  
  ggplot() + geom_col(aes(avg, reorder(dest, avg), fill = avg)) + scale_fill_continuous(type = "viridis")
```

```{r fig.width=6, fig.height=13}
flights %>%
  group_by(dest, hour) %>%
  filter(!is.na(dep_delay)) %>%
  filter(!is.na(dest)) %>% 
  summarise(tot_mins = sum(dep_delay[dep_delay > 0]),
            n = n(),
            avg = tot_mins/n,
            .groups = "keep") %>% 
  ggplot() + geom_point(aes(avg, reorder(dest, avg), col = hour)) + scale_color_gradientn(colours = rainbow(6))
```


```{r}
flight_weather %>%
  ungroup() %>%
  mutate(visib_cat = cut_interval(visib, n = 10)) %>%
  group_by(hour, visib_cat) %>%
  summarise(dep_delay = mean(dep_delay, na.rm = TRUE), .groups = "keep") %>%
  ggplot() +
  geom_point(aes(x = visib_cat, y = dep_delay, col = hour)) + 
  scale_color_gradientn(colours = rainbow(6)) + 
  labs(title = "Visibility vs. Departure Delay", 
       x = "Visibility", 
       y = "Mean Departure Delay", 
       caption = "Lower visibility means you can't see as far",
       col = "Hour")
```


# weather

```{r}
flight_weather =
  flights %>%
  inner_join(weather, by = c(
    "origin" = "origin",
    "year" = "year",
    "month" = "month",
    "day" = "day",
    "hour" = "hour")) %>% 
  mutate(delay = mean(dep_delay, na.rm = T))
```

# Precipitation

Almost any amount of precipitation is associated with a delay. However, there is not a strong a trend above 0.02 in. of precipitation.
```{r}
flight_weather %>% 
  ungroup() %>% 
  mutate(precip_cat = cut_interval(precip, 6)) %>% 
  group_by(precip_cat) %>% 
  summarise(delay = mean(dep_delay, na.rm = T)) %>% 
  ggplot(aes(x = precip_cat, y = delay, fill= delay)) +
  geom_col() + scale_fill_continuous(type = "viridis") 
```
```{r}
flight_weather %>% 
  ungroup() %>% 
  group_by(hour, precip) %>% 
  summarise(delay = mean(dep_delay, na.rm = T), .groups = "keep") %>% 
  ggplot() + geom_point(aes(x =hour, y = delay, col = precip)) + scale_color_gradientn(colours = rainbow(6))
```

```{r}
flight_weather %>% 
  ungroup() %>% 
  group_by(hour, precip) %>% 
  summarise(delay = mean(dep_delay, na.rm = T), .groups = "keep") %>% 
  ggplot() + geom_point(aes(x =precip, y = delay, col = hour)) + scale_color_gradientn(colours = rainbow(6))
```



# Visibility

There seems to be a stronger relationship between visibility and delay.
Delays are higher when visibility is less than 2 miles.
```{r}
flight_weather %>%
  ungroup() %>%
  mutate(visib_cat = cut_interval(visib, n = 10)) %>%
  group_by(visib_cat) %>%
  summarise(dep_delay = mean(dep_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = visib_cat, y = dep_delay, fill = dep_delay)) +
  geom_col() + scale_fill_continuous(type = "viridis") + 
  labs(title = "Visibility vs. Departure Delay", 
       x = "Visibility", 
       y = "Mean Departure Delay", 
       caption = "Lower visibility means you can't see as far",
       fill = "Mean Departure Delay")
```


```{r}
flight_weather %>%
  ungroup() %>%
  mutate(visib_cat = cut_interval(visib, n = 10)) %>%
  group_by(hour, visib_cat) %>%
  summarise(dep_delay = mean(dep_delay, na.rm = TRUE), .groups = "keep") %>%
  ggplot() +
  geom_point(aes(x = visib_cat, y = dep_delay, col = hour)) + 
  scale_color_gradientn(colours = rainbow(6)) + 
  labs(title = "Visibility vs. Departure Delay", 
       x = "Visibility", 
       y = "Mean Departure Delay", 
       caption = "Lower visibility means you can't see as far",
       col = "Hour")
```


